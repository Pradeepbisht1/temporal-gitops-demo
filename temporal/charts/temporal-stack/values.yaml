# === values.yaml (temporal/charts/temporal-stack/values.yaml) ===

# Disable non-SQL backends
cassandra:
  enabled: false

elasticsearch:
  enabled: false

mysql:
  enabled: false

# Temporal server uses SQL (Postgres)
server:
  # Pull SQL_* DSNs from secret
  envFrom:
    - secretRef:
        name: temporal-sql-secrets

  config:
    persistence:
      default:
        driver: "sql"
        sql:
          driver: "postgres"       # uses ${SQL_DEFAULT_DSN} from the secret
      visibility:
        driver: "sql"
        sql:
          driver: "postgres"       # uses ${SQL_VISIBILITY_DSN} from the secret

# Run Postgres schema jobs, wire secrets
schema:
  createDatabase:
    enabled: true
    envFrom:
      - secretRef:
          name: temporal-sql-secrets-admin
  setup:
    enabled: true
    envFrom:
      - secretRef:
          name: temporal-sql-secrets
  update:
    enabled: true
    envFrom:
      - secretRef:
          name: temporal-sql-secrets

prometheus:
  nodeExporter:
    # land on tainted nodes too
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"
      - key: "node-role.kubernetes.io/master"
        operator: "Exists"
        effect: "NoSchedule"
      - operator: "Exists"

    # exclude Fargate; only schedule on non-Fargate Linux nodes
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: eks.amazonaws.com/compute-type
                  operator: NotIn
                  values: ["fargate"]
                - key: kubernetes.io/os
                  operator: In
                  values: ["linux"]

    # keep requests small for easier placement
    resources:
      requests:
        cpu: 10m
        memory: 20Mi
